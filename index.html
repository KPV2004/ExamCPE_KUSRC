<!doctype html>
<html lang="th">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Exam CPE</title>
        <style>
            :root {
                --bg: #0b0c10;
                --card: #121319;
                --ink: #e6e6e6;
                --muted: #9aa1ab;
                --accent: #8ab4f8;
                --ok: #34c759;
                --bad: #ff453a;
            }
            * {
                box-sizing: border-box;
            }
            body {
                margin: 0;
                background: var(--bg);
                color: var(--ink);
                font:
                    16px/1.6 system-ui,
                    -apple-system,
                    Segoe UI,
                    Roboto,
                    Inter,
                    Helvetica,
                    Arial;
            }
            .wrap {
                max-width: 1000px;
                margin: 0 auto;
                padding: 24px;
            }
            .card {
                background: var(--card);
                border-radius: 16px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
                padding: 20px;
            }
            h1 {
                margin: 0 0 12px 0;
                font-weight: 800;
                font-size: 28px;
            }
            .muted {
                color: var(--muted);
            }
            .row {
                display: flex;
                gap: 14px;
                flex-wrap: wrap;
                align-items: center;
            }
            button,
            select,
            input[type="number"] {
                background: #1a1c24;
                color: var(--ink);
                border: 1px solid #2a2d3a;
                border-radius: 12px;
                padding: 10px 14px;
                font-weight: 600;
            }
            button.primary {
                background: var(--accent);
                color: #0b1020;
                border: none;
            }
            button.ghost {
                background: transparent;
                border: 1px dashed #2a2d3a;
            }
            button:disabled {
                opacity: 0.5;
            }
            .q {
                padding: 16px;
                border: 1px solid #242736;
                border-radius: 12px;
                margin: 12px 0;
            }
            .q h3 {
                margin: 0 0 8px 0;
                font-size: 18px;
            }
            .opts {
                display: grid;
                gap: 8px;
                margin-top: 8px;
            }
            .opt {
                padding: 10px;
                border: 1px solid #2a2d3a;
                border-radius: 10px;
                cursor: pointer;
            }
            .opt input {
                margin-right: 8px;
            }
            .pill {
                display: inline-block;
                background: #1a1c24;
                border: 1px solid #2a2d3a;
                border-radius: 999px;
                padding: 4px 10px;
                font-size: 12px;
            }
            .bar {
                height: 8px;
                background: #1a1c24;
                border: 1px solid #2a2d3a;
                border-radius: 999px;
                overflow: hidden;
            }
            .bar > i {
                display: block;
                height: 100%;
                background: var(--accent);
                width: 0;
            }
            .result {
                padding: 12px;
                border-radius: 12px;
            }
            .good {
                background: rgba(52, 199, 89, 0.15);
                border: 1px solid rgba(52, 199, 89, 0.35);
            }
            .bad {
                background: rgba(255, 69, 58, 0.12);
                border: 1px solid rgba(255, 69, 58, 0.35);
            }
            details summary {
                cursor: pointer;
            }
            code.block {
                white-space: pre-wrap;
                display: block;
                background: #0e1016;
                border: 1px solid #232636;
                border-radius: 12px;
                padding: 12px;
            }
        </style>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-c.min.js"></script>
    </head>
    <body>
        <div class="wrap">
            <div class="card">
                <h1>ชุดข้อสอบ Social & Politics</h1>
                <p class="muted">
                    ทำข้อสอบตัวเต็ม / สุ่มบางข้อ / ตรวจเฉลย
                    และดาวน์โหลดผลลัพธ์ได้
                </p>
                <div class="row" style="margin: 12px 0 6px">
                    <button id="btnStart" class="primary">
                        เริ่มทำข้อสอบตัวเต็ม
                    </button>
                    <div class="row">
                        <label for="num">สุ่ม</label>
                        <input
                            id="num"
                            type="number"
                            min="1"
                            max="90"
                            value="20"
                            style="width: 90px"
                        />
                        <button id="btnRandom">เริ่มโหมดสุ่ม</button>
                    </div>
                    <button id="btnReset" class="ghost">ล้างฟอร์ม</button>
                </div>
                <div
                    class="row"
                    style="justify-content: space-between; margin: 10px 0 0"
                >
                    <div>
                        <span class="pill" id="stat">ยังไม่ได้เริ่ม</span>
                    </div>
                    <div style="min-width: 200px; flex: 1; margin-left: 12px">
                        <div class="bar"><i id="progress"></i></div>
                    </div>
                </div>
            </div>

            <div id="quiz"></div>

            <div class="card" id="panelSubmit" style="display: none">
                <div class="row" style="justify-content: space-between">
                    <div class="muted">ตรวจคำตอบเมื่อทำเสร็จ</div>
                    <button id="btnSubmit" class="primary">ส่งคำตอบ</button>
                </div>
            </div>

            <div id="report"></div>

            <!-- <details class="card" style="margin-top:16px">
      <summary>แหล่งข้อมูล (RAW) & วิธีแปลงจากไฟล์</summary>
      <p class="muted">ด้านล่างคือข้อความจากไฟล์ PDF ที่คุณให้มา (ตัดแปะ) และสคริปต์จะแปลงเป็นโครงสร้างคำถามอัตโนมัติ – ถ้าต้องการแก้ไขข้อความ ตรงนี้คือจุดเดียวที่ต้องแก้</p>
      <code class="block" id="preview"></code>
    </details> -->
        </div>
        <script>
            (() => {
                // ===== A) รายชื่อไฟล์ข้อสอบ =====
                // แนะนำให้มีไฟล์ exam/manifest.json เป็นลิสต์ไฟล์ เช่น ["social_politics_midterm.json", ...]
                // ถ้าไม่มี manifest จะ fallback เป็นลิสต์ด้านล่างนี้
                const FALLBACK_FILES = [
                    "fundamental_programmingI_midterm.json",
                    "social_politics_midterm.json",
                    "laws_and_ethics_quiz_midterm.json",
                    "laws_and_ethics_midterm.json",
                    "laws_and_ethics_final.json",
                    "laws_and_ethics_quiz_final.json",
                    "social_politics_final.json",
                    "social_politics_final_V2.json",
                ];
                const EXAM_BASE = "exam/";

                // ===== B) เตรียม DOM =====
                const $quiz = document.getElementById("quiz");
                const $progress = document.getElementById("progress");
                const $stat = document.getElementById("stat");
                const $panelSubmit = document.getElementById("panelSubmit");
                const $report = document.getElementById("report");
                const $preview = document.getElementById("preview");
                const $title = document.querySelector("h1");

                // แทรก dropdown เลือกวิชาเข้าไปในหัวการ์ด
                const toolbarRow = document.querySelector(".card .row");
                const $examWrap = document.createElement("div");
                $examWrap.className = "row";
                $examWrap.style.marginRight = "auto";
                $examWrap.innerHTML = `
    <label for="examSelect">ชุดข้อสอบ</label>
    <select id="examSelect"></select>
  `;
                toolbarRow.prepend($examWrap);
                const $examSelect = document.getElementById("examSelect");

                // ===== C) สถานะภายใน =====
                let DATA = null; // payload จากไฟล์ json ปัจจุบัน
                let ITEMS = []; // แปลงเป็นรูปแบบใช้เรนเดอร์
                let current = []; // ชุดข้อที่ใช้งาน (เต็ม/สุ่ม)
                let answers = new Map(); // no -> selectedIndex

                // ===== D) Boot: โหลดรายชื่อไฟล์ + ตั้งค่า dropdown =====
                init();

                async function init() {
                    const files = await getExamFiles();
                    // เติม option ตามชื่อไฟล์
                    files.forEach((f) => {
                        const op = document.createElement("option");
                        op.value = f;
                        op.textContent = f.replace(/\.json$/, "");
                        $examSelect.appendChild(op);
                    });

                    // เลือกไฟล์จากพารามิเตอร์ ?exam=... ถ้ามี
                    const urlFile = new URLSearchParams(location.search).get(
                        "exam",
                    );
                    if (urlFile && files.includes(urlFile))
                        $examSelect.value = urlFile;

                    $examSelect.addEventListener("change", () =>
                        loadExam($examSelect.value),
                    );
                    // โหลดครั้งแรก
                    await loadExam($examSelect.value || files[0]);

                    // Wire ปุ่ม
                    document.getElementById("btnStart").onclick = () =>
                        start("full");
                    document.getElementById("btnRandom").onclick = () =>
                        start("random");
                    document.getElementById("btnReset").onclick = () => {
                        answers = new Map();
                        render();
                        $report.innerHTML = "";
                    };
                    document.getElementById("btnSubmit").onclick = grade;

                    // เริ่มต้นยังไม่เรนเดอร์ข้อจนกดเริ่ม
                    $quiz.innerHTML = "";
                }

                async function getExamFiles() {
                    try {
                        const r = await fetch(EXAM_BASE + "manifest.json", {
                            cache: "no-cache",
                        });
                        if (!r.ok) throw 0;
                        const list = await r.json();
                        if (Array.isArray(list) && list.length) return list;
                        return FALLBACK_FILES;
                    } catch {
                        return FALLBACK_FILES;
                    }
                }

                // ===== E) โหลดไฟล์ข้อสอบที่เลือก =====
                async function loadExam(filename) {
                    const res = await fetch(EXAM_BASE + filename, {
                        cache: "no-cache",
                    });
                    DATA = await res.json();

                    // แปลงเป็นโครงสร้างใช้งาน (อ่านเฉลยจาก A/B/C/D → index 0..3)
                    ITEMS = (DATA.questions || [])
                        .map((q) => ({
                            no: q.no,
                            stem: q.question,
                            options: q.choices,
                            answerIndex:
                                { A: 0, B: 1, C: 2, D: 3 }[q.answer] ?? null,
                        }))
                        .sort((a, b) => a.no - b.no);

                    // แสดงชื่อจาก meta.title และปรับ max สุ่มตาม count
                    const title =
                        DATA.meta?.title ||
                        $examSelect.value.replace(/\.json$/, "");
                    $title.innerHTML = `ชุดข้อสอบ ${title} `;
                    const $num = document.getElementById("num");
                    if ($num) {
                        $num.max = String(ITEMS.length);
                        if (
                            parseInt($num.value || "0", 10) >
                            parseInt($num.max, 10)
                        )
                            $num.value = $num.max;
                    }

                    // อัปเดต preview ให้โชว์ meta ใหม่
                    if ($preview) {
                        const meta = [
                            `title: ${title}`,
                            `count: ${ITEMS.length}`,
                            `missing_numbers: ${JSON.stringify(DATA.meta?.missing_numbers ?? [])}`,
                        ].join("\n");
                        $preview.textContent = meta;
                    }

                    // reset หน้าจอ
                    answers = new Map();
                    $report.innerHTML = "";
                    $panelSubmit.style.display = "none";
                    $quiz.innerHTML = "";
                    $progress.style.width = "0%";
                    $stat.textContent = "ยังไม่ได้เริ่ม";
                }

                // ===== F) โหมดเริ่มทำข้อสอบ =====
                function start(mode = "full") {
                    answers = new Map();
                    $report.innerHTML = "";
                    if (mode === "full") {
                        current = [...ITEMS];
                    } else {
                        const n = Math.max(
                            1,
                            Math.min(
                                parseInt(
                                    document.getElementById("num").value ||
                                        "20",
                                    10,
                                ),
                                ITEMS.length,
                            ),
                        );
                        current = shuffle([...ITEMS])
                            .slice(0, n)
                            .sort((a, b) => a.no - b.no);
                    }
                    render();
                }

                // ===== G) เรนเดอร์ข้อสอบ =====
                //   function render(){
                //     $quiz.innerHTML = '';
                //     const info = document.createElement('div');
                //     info.className='card';

                //     const missing = (DATA.meta?.missing_numbers ?? []);
                //     info.innerHTML = `<div class="row" style="justify-content:space-between;align-items:flex-end">
                //         <div>
                //           <div class="muted">จำนวนข้อที่ใช้ทดสอบ: <b>${current.length}</b> ข้อ
                //             ${missing.length ? `<span class="pill" title="หมายเลขข้อที่หาย: ${missing.join(', ')}">(หาย: ${missing.join(', ')})</span>` : ''}
                //           </div>
                //           <div class="muted">ตอบแล้ว: <b id="answeredCount">0</b>/<b>${current.length}</b></div>
                //         </div>
                //         <div class="row">
                //           <button onclick="toggleShuffle()">สลับลำดับ</button>
                //           <button onclick="showKey()">ดูเฉลยทุกข้อ</button>
                //         </div>
                //       </div>`;
                //     $quiz.appendChild(info);

                //     current.forEach((q)=>{
                //       const card = document.createElement('div');
                //       card.className = 'q';
                //       card.innerHTML = `<h3>${q.no}. ${q.stem}</h3>
                //         <div class="opts">${q.options.map((t,ix)=>{
                //           const id = `q${q.no}_${ix}`;
                //           return `<label class="opt"><input type="radio" name="q${q.no}" value="${ix}" id="${id}" /> ${'ABCD'[ix]}) ${t}</label>`;
                //         }).join('')}</div>`;
                //       $quiz.appendChild(card);
                //       card.addEventListener('change', (e)=>{
                //         const sel = parseInt(e.target.value,10);
                //         answers.set(q.no, sel);
                //         updateProgress();
                //       });
                //     });
                //     $panelSubmit.style.display = 'block';
                //     updateProgress();
                //   }
                function render() {
                    $quiz.innerHTML = "";
                    const info = document.createElement("div");
                    info.className = "card";

                    const missing = DATA.meta?.missing_numbers ?? [];
                    info.innerHTML = `<div class="row" style="justify-content:space-between;align-items:flex-end">
      <div>
        <div class="muted">จำนวนข้อที่ใช้ทดสอบ: <b>${current.length}</b> ข้อ
          ${missing.length ? `<span class="pill" title="หมายเลขข้อที่หาย: ${missing.join(", ")}">(หาย: ${missing.join(", ")})</span>` : ""}
        </div>
        <div class="muted">ตอบแล้ว: <b id="answeredCount">0</b>/<b>${current.length}</b></div>
      </div>
      <div class="row">
        <button onclick="toggleShuffle()">สลับลำดับ</button>
        <button onclick="showKey()">ดูเฉลยทุกข้อ</button>
      </div>
    </div>`;
                    $quiz.appendChild(info);

                    current.forEach((q) => {
                        const card = document.createElement("div");
                        card.className = "q";

                        // ✅ ตรวจจับ ```lang ... ``` แล้วแปลงเป็น block code
                        let stemHtml = q.stem
                            .replace(
                                /```(\w+)?\n([\s\S]*?)```/g,
                                (m, lang, code) => {
                                    return `<pre><code class="language-${lang || ""}">${escapeHtml(code)}</code></pre>`;
                                },
                            )
                            .replace(/\n/g, "<br>");

                        card.innerHTML = `<h3>${q.no}. ${stemHtml}</h3>
      <div class="opts">${q.options
          .map((t, ix) => {
              const id = `q${q.no}_${ix}`;
              return `<label class="opt"><input type="radio" name="q${q.no}" value="${ix}" id="${id}" /> ${"ABCD"[ix]}) ${t}</label>`;
          })
          .join("")}</div>`;
                        $quiz.appendChild(card);
                        card.addEventListener("change", (e) => {
                            const sel = parseInt(e.target.value, 10);
                            answers.set(q.no, sel);
                            updateProgress();
                        });
                    });
                    $panelSubmit.style.display = "block";
                    updateProgress();
                }

                function escapeHtml(str) {
                    return str.replace(
                        /[&<>'"]/g,
                        (t) =>
                            ({
                                "&": "&amp;",
                                "<": "&lt;",
                                ">": "&gt;",
                                '"': "&quot;",
                                "'": "&#39;",
                            })[t],
                    );
                }

                // ===== H) เครื่องมืออื่น ๆ =====
                function shuffle(arr) {
                    for (let i = arr.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [arr[i], arr[j]] = [arr[j], arr[i]];
                    }
                    return arr;
                }

                function updateProgress() {
                    const done = answers.size,
                        total = current.length;
                    $progress.style.width = (done / total) * 100 + "%";
                    document.getElementById("answeredCount").textContent = done;
                    $stat.textContent =
                        done === 0
                            ? "ยังไม่ได้เริ่ม"
                            : `ตอบแล้ว ${done}/${total} ข้อ`;
                    document.getElementById("btnSubmit").disabled = done === 0;
                }

                function grade() {
                    let correct = 0,
                        wrong = [];
                    for (const q of current) {
                        const sel = answers.get(q.no);
                        if (sel === q.answerIndex) correct++;
                        else wrong.push({ q, sel });
                    }
                    const score = Math.round((correct / current.length) * 100);
                    const box = document.createElement("div");
                    box.className = "card";
                    box.innerHTML = `
      <div class="result ${wrong.length ? "bad" : "good"}">
        <h2 style="margin:0 0 6px">คะแนน: ${correct}/${current.length} (${score}%)</h2>
        <div class="muted">ตอบผิด ${wrong.length} ข้อ</div>
        <div class="row" style="margin-top:8px">
          <button onclick="downloadCSV()">ดาวน์โหลดผลลัพธ์ (.csv)</button>
          <button class="ghost" onclick="review()">ไฮไลต์เฉลยในข้อสอบ</button>
        </div>
      </div>
      ${
          wrong.length
              ? `<div style="margin-top:12px"><details open><summary><b>สรุปรายการที่ตอบผิด</b></summary>
        ${wrong
            .map((w) => {
                const corr = "ABCD"[w.q.answerIndex];
                const you = w.sel == null ? "—" : "ABCD"[w.sel];
                return `<div class="q"><div><b>ข้อ ${w.q.no}</b> – คำถาม: ${w.q.stem}</div>
            <div class="muted">ตอบ: ${you || "—"} | เฉลยที่ถูก: <b>${corr}</b></div></div>`;
            })
            .join("")}
      </details></div>`
              : ""
      }
    `;
                    $report.innerHTML = "";
                    $report.appendChild(box);
                }

                function review() {
                    const nameSet = new Set(current.map((q) => `q${q.no}`));
                    nameSet.forEach((n) => {
                        const inputs = document.querySelectorAll(
                            `input[name="${n}"]`,
                        );
                        inputs.forEach((inp) => {
                            const [noStr, ixStr] = inp.id.split("_");
                            const no = parseInt(noStr.replace(/\D/g, ""), 10);
                            const ix = parseInt(ixStr, 10);
                            const q = current.find((x) => x.no === no);
                            const parent = inp.closest(".opt");
                            parent.style.borderColor =
                                ix === q.answerIndex ? "var(--ok)" : "#2a2d3a";
                            if (inp.checked && ix !== q.answerIndex) {
                                parent.style.borderColor = "var(--bad)";
                            }
                        });
                    });
                }

                function toggleShuffle() {
                    current = shuffle(current);
                    render();
                }

                function showKey() {
                    current.forEach((q) => answers.set(q.no, q.answerIndex));
                    updateProgress();
                    review();
                }

                function downloadCSV() {
                    const rows = [
                        ["No", "Your", "Correct", "Result", "Question"],
                    ];
                    for (const q of current) {
                        const you = answers.has(q.no)
                            ? "ABCD"[answers.get(q.no)]
                            : "";
                        const corr = "ABCD"[q.answerIndex] || "";
                        const ok =
                            answers.get(q.no) === q.answerIndex
                                ? "OK"
                                : "WRONG";
                        rows.push([
                            q.no,
                            you,
                            corr,
                            ok,
                            q.stem.replace(/\n/g, " "),
                        ]);
                    }
                    const csv = rows
                        .map((r) =>
                            r
                                .map(
                                    (x) => `"${String(x).replace(/"/g, '""')}"`,
                                )
                                .join(","),
                        )
                        .join("\n");
                    const blob = new Blob([csv], {
                        type: "text/csv;charset=utf-8;",
                    });
                    const a = document.createElement("a");
                    a.href = URL.createObjectURL(blob);
                    a.download = "exam_result.csv";
                    a.click();
                }

                // ให้ปุ่มเรียกใช้ได้หลัง render
                window.toggleShuffle = toggleShuffle;
                window.showKey = showKey;
                window.downloadCSV = downloadCSV;
            })();
        </script>
    </body>
</html>
